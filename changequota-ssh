#!/bin/bash
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RESET='\033[0m'

function change_ssh_quota() {
  echo -e "${CYAN}---------------------------------------------${RESET}"
  echo -e "${YELLOW}   USERNAME       EXP DATE         STATUS${RESET}"
  echo -e "${CYAN}---------------------------------------------${RESET}"
  
  while read user_line; do
    AKUN=$(echo $user_line | cut -d: -f1)
    ID=$(echo $user_line | cut -d: -f3)
    if [[ $ID -ge 1000 ]]; then
      exp=$(chage -l "$AKUN" | grep "Account expires" | awk -F": " '{print $2}')
      status=$(passwd -S "$AKUN" | awk '{print $2}')
      if [[ "$status" == "L" ]]; then
        printf "%-17s %-17s ${RED}%s${RESET}\n" "$AKUN" "$exp" "LOCKED"
      else
        printf "%-17s %-17s ${GREEN}%s${RESET}\n" "$AKUN" "$exp" "UNLOCKED"
      fi
    fi
  done < /etc/passwd

  echo -e "${CYAN}---------------------------------------------${RESET}"
  JUMLAH=$(awk -F: '$3 >= 1000 {print $1}' /etc/passwd | wc -l)
  echo -e "${YELLOW}   Total Users: $JUMLAH${RESET}"
  echo -e "${CYAN}---------------------------------------------${RESET}"
  echo ""

  read -p "Input username: " user
  quota_file="/etc/ssh/$user"
  
  if [ -e "$quota_file" ]; then
    current_quota=$(cat "$quota_file")
    echo -e "${CYAN}---------------------------------------------${RESET}"
    echo -e "${GREEN}Current Quota for $user: $((current_quota / 1024 / 1024 / 1024)) GB${RESET}"
    echo -e "${CYAN}---------------------------------------------${RESET}"
  else
    echo -e "${RED}No quota set for $user.${RESET}"
  fi

  read -p "Enter new quota (in GB): " new_quota
  if [[ -z "$new_quota" || ! "$new_quota" =~ ^[0-9]+$ ]]; then
    echo -e "${RED}Invalid input. No changes made.${RESET}"
    read -n 1 -s -r -p "Press any key to back on menu"
    m-ssh
  fi

  new_quota_bytes=$((new_quota * 1024 * 1024 * 1024))
  mkdir -p "$(dirname "$quota_file")"
  echo "$new_quota_bytes" > "$quota_file"

  echo -e "${CYAN}---------------------------------------------${RESET}"
  echo -e "${GREEN}Quota successfully updated.${RESET}"
  echo -e "${GREEN}Username   : $user${RESET}"
  echo -e "${GREEN}New Quota  : $new_quota GB${RESET}"
  echo -e "${CYAN}---------------------------------------------${RESET}"

  # Update the database
  db_file="/etc/ssh/.ssh.db"
  mkdir -p "$(dirname "$db_file")"
  DATADB=$(grep "^#ssh# ${user} " "$db_file" || true)
  ge=$(grep -w "$user" /etc/limit/ssh/ip | cat || echo 0)

  # Remove existing entry if it exists
  if [[ -n "$DATADB" ]]; then
    sed -i "/^#ssh# ${user} /d" "$db_file"
  fi

  # Save the new quota to the database
  echo "#ssh# ${user} $(date +%Y-%m-%d) ${new_quota_bytes}" >> "$db_file"
  echo "#ssh# ${user} $(date +%Y-%m-%d) ${new_quota_bytes}" >> "$ge"
  echo -e "${GREEN}Database successfully updated.${RESET}"
  
  read -n 1 -s -r -p "Press any key to back on menu"
  m-ssh
}

# Run the function
change_ssh_quota