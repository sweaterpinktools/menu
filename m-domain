#!/bin/bash
clear
PERMISSION() {
    MYIP=$(curl -sS ipv4.icanhazip.com)

    TODAY_DATE=$(date +'%Y-%m-%d')

    AUTHORIZED_ENTRY=$(curl -sS https://raw.githubusercontent.com/sweaterpinktools/os/main/ip | grep -w "$MYIP" | head -1)

    if [[ -n "$AUTHORIZED_ENTRY" ]]; then
        # IP_FROM_ENTRY sekarang adalah field ke-4
        IP_FROM_ENTRY=$(echo "$AUTHORIZED_ENTRY" | awk '{print $4}')
        # EXP_DATE_OR_LIFETIME_STATUS sekarang adalah field ke-3
        EXP_DATE_OR_LIFETIME_STATUS=$(echo "$AUTHORIZED_ENTRY" | awk '{print $3}') 

        if [ "$MYIP" = "$IP_FROM_ENTRY" ]; then
            # Cek apakah statusnya 'lifetime'
            if [[ "$EXP_DATE_OR_LIFETIME_STATUS" == "lifetime" ]]; then
                echo -e "\033[1;92mPermission Accepted (Lifetime User)\033[0m"
                echo -e "\033[1;97mAkses Di Izinkan (Pengguna Lifetime)${NC}"
            # Jika bukan 'lifetime', baru lakukan perbandingan tanggal
            elif [[ "$TODAY_DATE" < "$EXP_DATE_OR_LIFETIME_STATUS" ]]; then
                echo -e "\033[1;92mPermission Accepted\033[0m"
                echo -e "\033[1;97mAkses Di Izinkan${NC}"
            elif [[ "$TODAY_DATE" == "$EXP_DATE_OR_LIFETIME_STATUS" ]]; then
                echo -e "\033[1;93mPermission Accepted (Today is Expiry Date)\033[0m"
                echo -e "\033[1;97mAkses Di Izinkan (Hari Ini Kadaluarsa)${NC}"
            else
                echo -e "\033[1;91mPermission Denied (Expired)\033[0m"
                echo -e "\033[1;97mAkses Di Tolak (Kadaluarsa)${NC}"
                read -n 1 -s -r -p "Press [ Enter ] to Exit"
                exit 1
            fi
        else
            echo -e "\033[1;91mPermission Denied (IP Mismatch)\033[0m"
            echo -e "\033[1;97mAkses Di Tolak (IP Tidak Cocok)${NC}"
            read -n 1 -s -r -p "Press [ Enter ] to Exit"
            exit 1
        fi
    else
        echo -e "\033[1;91mPermission Denied (IP Not Found)\033[0m"
        echo -e "\033[1;97mAkses Di Tolak (IP Tidak Ditemukan)${NC}"
        read -n 1 -s -r -p "Press [ Enter ] to Exit"
        exit 1
    fi
}

PERMISSION
clear
y='\033[1;33m'
BGX="\033[42m"
CYAN="\033[96m"
Putih="\033[97m"
RED='\033[0;31m'
NC='\033[0m'
green='\033[0;32m'
BIBlack='\033[1;90m'
BIGreen='\033[1;92m'
BIYellow='\033[1;93m'
BIBlue='\033[1;94m'
BIPurple='\033[1;95m'
BICyan='\033[1;96m'
BIWhite='\033[1;97m'
UWhite='\033[4;37m'
On_IPurple='\033[0;105m'
On_IRed='\033[0;101m'
IBlack='\033[0;90m'
IGreen='\033[0;92m'
IYellow='\033[0;93m'
IBlue='\033[0;94m'
IPurple='\033[0;95m'
ICyan='\033[0;96m'
IWhite='\033[0;97m'
GREENBO='\033[1;32m'
bgwhite='\e[40;97;1m'
bgred='\e[41;97;1m'
bggreen='\e[42;97;1m'
bgyellow='\e[43;97;1m'
bgmagenta='\e[45;97;1m'
bgblue='\e[46;97;1m'
bgblack='\e[47;30;1m'
w='\033[97m'
ORANGE='\033[0;34m'
clear
update_domain_and_ns() {
    local dom="$1"
    local nsdomen="$2"

    # Cek apakah input valid (tidak kosong)
    if [[ -z "$dom" || -z "$nsdomen" ]]; then
        echo -e "\033[31mDomain dan Nameserver tidak boleh kosong. Silakan coba lagi.\033[0m"
        return 1
    fi

    # Memastikan direktori dan file yang dibutuhkan ada
    if ! [ -d "/etc/xray" ]; then
        echo -e "\033[33mDirektori /etc/xray tidak ditemukan, membuat direktori...\033[0m"
        mkdir -p /etc/xray
    fi

    # Menyimpan domain dan Nameserver ke dalam file sesuai direktori yang ditentukan
    echo "IP=$dom" > /var/lib/ipvps.conf
    echo "$dom" > /root/domain
    echo "$dom" > /etc/xray/domain
    echo "$nsdomen" > /root/nsdomain
    echo "$nsdomen" > /etc/xray/dns

    # Output informasi
    echo -e "\n\033[32mDomain dan Nameserver berhasil diperbarui!\033[0m"
    echo -e "Domain baru: \033[36m$dom\033[0m"
    echo -e "Nameserver baru: \033[36m$nsdomen\033[0m"
    read -n 1 -s -r -p "Press [ Enter ] to kembali ke menu"
    m-domain
}

# Fungsi untuk mengganti hanya Nameserver
update_ns() {
    local nsdomen="$1"

    # Cek apakah input valid (tidak kosong)
    if [[ -z "$nsdomen" ]]; then
        echo -e "\033[31mNameserver tidak boleh kosong. Silakan coba lagi.\033[0m"
        return 1
    fi

    # Menyimpan Nameserver ke dalam file sesuai direktori yang ditentukan
    echo "$nsdomen" > /root/nsdomain
    echo "$nsdomen" > /etc/xray/dns

    # Output informasi
    echo -e "\n\033[32mNameserver berhasil diperbarui!\033[0m"
    echo -e "Nameserver baru: \033[36m$nsdomen\033[0m"
    read -n 1 -s -r -p "Press [ Enter ] to kembali ke menu"
    m-domain
}

update_domain() {
    local domain="$1"

    # Cek apakah input valid (tidak kosong)
    if [[ -z "$dom" ]]; then
        echo -e "\033[31mdomain tidak boleh kosong. Silakan coba lagi.\033[0m"
        return 1
    fi

    # Menyimpan domain ke dalam file sesuai direktori yang ditentukan
    echo "$dom" > /etc/xray/domain
    echo "$dom" > /root/domain

    # Output informasi
    echo -e "\n\033[32mdomain berhasil diperbarui!\033[0m"
    echo -e "domain baru: \033[36m$dom\033[0m"
    read -n 1 -s -r -p "Press [ Enter ] to kembali ke menu"
    m-domain
}

clear 
echo -e "${BIWhite}──────────────────────────────────────${NC}"
echo -e "${BIYellow}DOMAIN MANAGER${NC}"
echo -e "${BIWhite}──────────────────────────────────────${NC}"
echo -e "${IGreen}[${BIWhite}01${IGreen}] ${NC}${BIWhite}Change Domain & Nameserver${NC}"
echo -e "${IGreen}[${BIWhite}02${IGreen}] ${NC}${BIWhite}Change Domain Only${NC}"
echo -e "${IGreen}[${BIWhite}03${IGreen}] ${NC}${BIWhite}Change Nameserver Only${NC}"
echo -e "${IGreen}[${BIWhite}04${IGreen}] ${NC}${BIWhite}Renew Certificate Domain${NC}"
echo -e "${IGreen}[${BIWhite}05${IGreen}] ${NC}${BIWhite}Change Domain & Certificate${NC}"
echo -e "${BIWhite}──────────────────────────────────────${NC}"
echo -e "${BIYellow}Input x or [ Ctrl+C ] • To-${BIWhite}Exit${NC}"
echo -e "${BIWhite}──────────────────────────────────────${NC}"
echo -e ""
read -p "Select menu :" opt
echo -e "" 
case $opt in
1)
clear
read -p "domain baru: " dom
read -p "Nameserver baru: " nsdomen
update_domain_and_ns "$dom" "$nsdomen"
;;
2)
clear
read -p "Domain Baru: " dom
update_domain "$dom"
;;
3)
clear
read -p "Nameserver baru: " nsdomen
update_ns "$nsdomen"
;;  
4)
clear
fixcert
;;
5)
clear
addhost
;;   
x)
clear
menu
;;
*)
echo -e "Anda salah tekan"
sleep 1
m-domain
;;
esac